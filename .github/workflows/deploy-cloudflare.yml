name: Deploy to Cloudflare Pages

# Manual trigger only - to avoid conflicts with Vercel deployment
# Use this workflow when deploying to Cloudflare Pages instead of Vercel
on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Deployment environment'
        required: true
        default: 'production'
        type: choice
        options:
          - production
          - preview

# Build-time environment variables (dummy values for build only)
# Runtime values are configured in Cloudflare Pages Dashboard
env:
  DATABASE_URL: postgres://build:build@localhost:5432/build
  JWT_SECRET: build-jwt-secret-must-be-at-least-32-characters
  JWT_REFRESH_SECRET: build-refresh-secret
  NEXTAUTH_SECRET: build-nextauth-secret
  VIDEO_API_URL: http://localhost:8080
  PLAYBACK_TOKEN_SECRET: build-playback-secret-at-least-32-chars

jobs:
  # Check if Cloudflare secrets are configured
  check-secrets:
    runs-on: ubuntu-latest
    steps:
      - name: Check Cloudflare secrets
        run: |
          if [ -z "${{ secrets.CLOUDFLARE_API_TOKEN }}" ] || [ -z "${{ secrets.CLOUDFLARE_ACCOUNT_ID }}" ]; then
            echo "::error::Missing Cloudflare secrets. Please configure CLOUDFLARE_API_TOKEN and CLOUDFLARE_ACCOUNT_ID in repository settings."
            exit 1
          fi

  deploy:
    runs-on: ubuntu-latest
    needs: check-secrets
    permissions:
      contents: read
      deployments: write
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Build for Cloudflare Pages
        run: npm run pages:build

      - name: Deploy to Cloudflare Pages
        uses: cloudflare/wrangler-action@v3
        with:
          apiToken: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          accountId: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}
          command: pages deploy .vercel/output/static --project-name=movie-app

# ============================================================
# 配置说明
# ============================================================
#
# ⚠️ 重要: Cloudflare Pages 使用 Edge Runtime
# 此项目需要使用支持 HTTP 连接的数据库服务
# 推荐使用 Neon (https://neon.tech)
#
# 1. 创建 Neon 数据库
#    - 注册 Neon 账号
#    - 创建新项目和数据库
#    - 复制连接字符串 (pooled connection)
#
# 2. 创建 Cloudflare API Token
#    - 登录 Cloudflare Dashboard
#    - 进入 My Profile > API Tokens
#    - 创建 Token，选择 "Edit Cloudflare Workers" 模板
#    - 添加到 GitHub Secrets: CLOUDFLARE_API_TOKEN
#
# 3. 获取 Account ID
#    - 在 Cloudflare Dashboard 右侧边栏可以看到
#    - 添加到 GitHub Secrets: CLOUDFLARE_ACCOUNT_ID
#
# 4. 配置环境变量 (在 Cloudflare Pages Dashboard)
#    - DATABASE_URL (Neon 连接字符串)
#    - JWT_SECRET
#    - JWT_REFRESH_SECRET
#    - NEXTAUTH_SECRET
#    - VIDEO_API_URL
#    - PLAYBACK_TOKEN_SECRET
#
# ============================================================
